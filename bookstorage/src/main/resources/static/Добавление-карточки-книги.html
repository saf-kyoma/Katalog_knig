<!DOCTYPE html>
<html style="font-size: 16px;" lang="ru">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">
  <title>Добавление карточки книги</title>
  <link rel="stylesheet" href="nicepage.css" media="screen">
  <link rel="stylesheet" href="Добавление-карточки-книги.css" media="screen">
  <script class="u-script" type="text/javascript" src="jquery.js" defer></script>
  <script class="u-script" type="text/javascript" src="nicepage.js" defer></script>
  <meta name="theme-color" content="#2cccc4">

  <style>
    /* Основные стили формы */
    .u-form-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 15px;
      position: relative;
    }

    .u-label {
      font-weight: bold;
      margin-bottom: 5px;
      text-align: left;
    }

    .u-input, .u-input-number, .u-select {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* Стили для тегов жанров */
    .tags-input-container {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 5px;
      align-items: center;
      position: relative;
    }

    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }

    .tag {
      background-color: #3498db;
      color: white;
      padding: 5px 10px;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      font-size: 14px;
      font-family: Arial, sans-serif;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: background-color 0.3s ease;
    }

    .tag:hover {
      background-color: #2980b9;
    }

    .remove-tag {
      margin-left: 8px;
      cursor: pointer;
      font-weight: bold;
      color: #ffffff;
      transition: color 0.3s ease;
    }

    .remove-tag:hover {
      color: #ff0000;
    }

    /* Стили для списков подсказок */
    .suggestions-list {
      position: absolute;
      background-color: white;
      border: 1px solid #ccc;
      border-top: none;
      width: 100%;
      max-height: 150px;
      overflow-y: auto;
      z-index: 1000;
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .suggestions-list li {
      padding: 8px;
      cursor: pointer;
    }

    .suggestions-list li:hover {
      background-color: #f0f0f0;
    }

    .author-suggestions-list {
      position: absolute;
      background-color: white;
      border: 1px solid #ccc;
      border-top: none;
      width: 100%;
      max-height: 150px;
      overflow-y: auto;
      z-index: 1000;
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .author-suggestions-list li {
      padding: 8px;
      cursor: pointer;
    }

    .author-suggestions-list li:hover {
      background-color: #f0f0f0;
    }

    /* Стили для динамических групп авторов */
    .author-group {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
      position: relative;
    }

    .remove-author {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
      color: red;
      font-weight: bold;
      display: none; /* Скрыто для первого автора */
      font-size: 18px;
      z-index: 1001;
    }

    .author-group:hover .remove-author {
      display: block;
    }

    .add-author-btn {
      padding: 8px 12px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .add-author-btn:hover {
      background-color: #2980b9;
    }

    /* Стили для кнопок */
    .buttons-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }

    .u-btn {
      flex: 0 1 auto;
      min-width: 120px;
      max-width: 200px;
      text-align: center;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }

    .u-btn-submit {
      background-color: #2ecc71;
      color: white;
    }

    .u-btn-submit:hover {
      background-color: #27ae60;
    }

    .u-btn-cancel {
      background-color: #e74c3c;
      color: white;
      text-decoration: none;
      display: inline-block;
    }

    .u-btn-cancel:hover {
      background-color: #c0392b;
    }

    /* Стили для сообщений */
    .u-form-send-message {
      display: none;
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
      font-weight: bold;
    }

    .u-form-send-success {
      background-color: #2ecc71;
      color: white;
    }

    .u-form-send-error {
      background-color: #e74c3c;
      color: white;
    }

    /* Стили для страницы */
    .u-sheet {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    .u-text-1 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 24px;
      font-weight: bold;
      writing-mode: horizontal-tb;
      transform: rotate(0deg);
    }

    /* Медиа-запросы для адаптивности */
    @media (max-width: 768px) {
      .buttons-container {
        flex-direction: column;
      }

      .u-btn {
        width: 100%;
        max-width: none;
      }
    }
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f4;
    }

    header {
        background-color: #2cccc4;
        color: #fff;
        padding: 10px 20px;
        text-align: center;
    }

    nav {
        background-color: #249a9a;
        padding: 10px;
    }

    nav ul {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
    }

    nav ul li {
        margin: 0 15px;
    }

    nav ul li a {
        color: white;
        text-decoration: none;
        font-weight: bold;
    }

    nav ul li a:hover {
        text-decoration: underline;
    }

    .container {
        margin: 20px auto;
        max-width: 800px;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }

    table th, table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
        width: 25%; /* Каждая колонка равной ширины */
    }

    table th {
        background-color: #2cccc4;
        color: white;
        text-transform: uppercase;
    }

    table tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    nav.u-menu {
    width: 100% !important;
    display: flex !important;
    justify-content: center !important;
    }

    nav.u-menu ul {
        display: flex !important;
        justify-content: center !important;
        width: 100% !important;
        padding: 0;
        margin: 0;
    }

    nav.u-menu ul li {
        flex: 1 !important;
        text-align: center !important;
    }

    nav.u-menu ul li a {
        display: block;
        width: 100%;
        padding: 10px 0;
        color: white;
        text-decoration: none;
        font-weight: bold;
    }

    nav.u-menu ul li a:hover {
        text-decoration: underline;
        color: #fff;
    }


    .btn {
        display: inline-block;
        padding: 10px 15px;
        margin: 5px;
        border: none;
        border-radius: 5px;
        background-color: #2cccc4;
        color: #fff;
        text-decoration: none;
        text-align: center;
    }

    .btn:hover {
        background-color: #249a9a;
    }
  </style>
</head>
<body class="u-body u-xl-mode" data-lang="ru">
<header>
  <h1>Добавление книги</h1>

</header>
<nav class="u-dropdown-icon u-menu u-menu-dropdown u-menu-1 d-flex justify-content-center w-100" data-responsive-from="XS" data-submenu-level="on-click">
  <ul class="d-flex justify-content-center w-100">
    <li class="mx-2 flex-fill text-center"><a href="Каталог.html">Каталог</a></li>
    <li class="mx-2 flex-fill text-center"><a href="Страница-авторов.html">Авторы</a></li>
    <li class="mx-2 flex-fill text-center"><a href="Страница-издательств.html">Издательства</a></li>
    <li class="mx-2 flex-fill text-center"><a href="Вход-в-систему.html">Войти</a></li>
  </ul>
  <style class="menu-style">
    @media (max-width: 539px) {
      [data-responsive-from="XS"] .u-nav-container {
          display: none;
      }
      [data-responsive-from="XS"] .menu-collapse {
          display: block;
      }
    }
  </style>
</nav>



<section class="u-clearfix u-section-1" id="sec-64ce">
    <!-- Форма добавления книги -->
    <div class="container">
      <form id="book-add-form" class="u-clearfix u-form-spacing-10 u-form-vertical u-inner-form">

        <!-- ISBN -->
        <div class="u-form-group">
          <label for="isbn" class="u-label">ISBN</label>
          <input
                  type="text"
                  id="isbn"
                  name="isbn"
                  class="u-input"
                  placeholder="978-0-00-000000-0"
                  maxlength="17"
                  title="Введите ISBN-13 в формате 978-0-00-000000-0"
                  required
          >
        </div>

        <!-- Название книги -->
        <div class="u-form-group">
          <label for="name" class="u-label">Название</label>
          <input type="text" placeholder="Введите название книги" id="name" name="name" class="u-input" required pattern="[A-Za-zА-Яа-я0-9\s\-]+" title="Разрешены только буквы, цифры, пробелы и дефис (-)">
        </div>

        <!-- Год публикации -->
        <div class="u-form-group">
          <label for="publicationYear" class="u-label">Год</label>
          <input type="date" id="publicationYear" name="publicationYear" class="u-input-number" required>
        </div>

        <!-- Возрастное ограничение -->
        <div class="u-form-group">
          <label for="ageLimit" class="u-label">Возрастное ограничение</label>
          <select id="ageLimit" name="ageLimit" class="u-input" required>
            <option value="" disabled selected>Выберите возрастное ограничение</option>
            <option value="0">0+</option>
            <option value="6">6+</option>
            <option value="12">12+</option>
            <option value="16">16+</option>
            <option value="18">18+</option>
          </select>
        </div>

        <!-- Издатель -->
        <div class="u-form-group" style="position: relative;">
          <label for="publishingCompany" class="u-label">Издатель</label>
          <input
                  type="text"
                  placeholder="Введите название издательства"
                  id="publishingCompany"
                  name="publishingCompany"
                  class="u-input"
                  required
                  pattern="[A-Za-zА-Яа-я0-9\s\-]+"
                  title="Разрешены только буквы, цифры, пробелы и дефис (-)"
                  autocomplete="off"
          >
          <!-- Список подсказок -->
          <ul id="publishingCompany-suggestions" class="suggestions-list" style="display: none;">
            <!-- Элементы списка будут добавляться динамически -->
          </ul>
        </div>

        <!-- Количество страниц -->
        <div class="u-form-group">
          <label for="pageCount" class="u-label">Страницы</label>
          <input type="number" id="pageCount" name="pageCount" class="u-input-number" value="1" min="1" max="10000" step="1" required>
        </div>

        <!-- Язык -->
        <div class="u-form-group">
          <label for="language" class="u-label">Язык</label>
          <select id="language" name="language" class="u-input" required>
            <option value="" disabled selected>Выберите язык</option>
            <option value="Русский">Русский</option>
            <option value="Английский">Английский</option>
            <option value="Немецкий">Немецкий</option>
            <option value="Китайский">Китайский</option>
            <option value="Японский">Японский</option>
            <option value="Португальский">Португальский</option>
            <option value="Испанский">Испанский</option>
            <option value="Итальянский">Итальянский</option>
            <option value="Польский">Польский</option>
          </select>
        </div>

        <!-- Цена -->
        <div class="u-form-group">
          <label for="cost" class="u-label">Цена</label>
          <input type="number" id="cost" name="cost" class="u-input-number" min="0" step="0.01" required placeholder="Введите цену">
        </div>

        <!-- Количество книг -->
        <div class="u-form-group">
          <label for="countOfBooks" class="u-label">Кол-во</label>
          <input type="number" id="countOfBooks" name="countOfBooks" class="u-input-number" value="0" min="0" max="10000" step="1" required>
        </div>

        <!-- Авторы -->
        <div class="u-form-group">
          <label for="authors-container" class="u-label">Авторы</label>
          <div id="authors-container">
            <div class="author-group">
              <span class="remove-author">&times;</span>
              <div class="u-form-group">
                <label for="authorFio" class="u-label">ФИО автора</label>
                <input type="text" placeholder="Введите ФИО автора" id="authorFio" name="authorFio" class="u-input author-fio" required pattern="[A-Za-zА-Яа-яЁё\s\-]+" title="Разрешены только буквы, пробелы и дефис (-)">
                <ul class="author-suggestions-list" style="display: none;"></ul>
                <input type="hidden" name="authorId" class="author-id">
              </div>
            </div>
          </div>
          <button type="button" class="add-author-btn">Добавить автора</button>
        </div>

        <!-- Жанры -->
        <div class="u-form-group">
          <label for="genre-input" class="u-label">Жанры</label>
          <div class="tags-input-container">
            <div id="genre-tags" class="tags-container"></div>
            <input type="text" id="genre-input" class="u-input" placeholder="Введите жанр и нажмите Enter">
            <input type="hidden" id="genres-hidden" name="genres">
          </div>
        </div>

        <!-- Кнопки добавления и отмены -->
        <div class="u-form-group u-form-submit buttons-container">
          <!-- Кнопка Добавления -->
          <button type="submit" class="u-btn u-btn-submit">Добавить</button>

          <!-- Кнопка Отмены -->
          <a href="Каталог.html" class="u-btn u-btn-cancel">Отмена</a>
        </div>

        <!-- Сообщения об отправке -->
        <div class="u-form-send-message u-form-send-success">Спасибо! Ваша книга добавлена.</div>
        <div class="u-form-send-error u-form-send-message">Отправка не удалась. Пожалуйста, исправьте ошибки и попробуйте еще раз.</div>

        <!-- Скрытые поля -->
        <input type="hidden" value="" name="recaptchaResponse">
        <input type="hidden" name="formServices" value="234d2f51-51fe-7107-fa98-0d7a5e49113d">
      </form>
    </div>

  </div>
</section>

<!-- Подвал сайта -->
<footer class="u-align-center u-clearfix u-footer u-grey-80 u-footer" id="sec-2f71">
  <div class="u-clearfix u-sheet u-sheet-1">
    <p class="u-small-text u-text u-text-variant u-text-1">
      О вопросах и проблемах сообщать главному администратору или писать на почту <a href="mailto:GlobalMaster@book.com">GlobalMaster@book.com</a>
    </p>
  </div>
</footer>

<!-- Скрипты валидации и функциональности -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 1. Очистка нежелательных символов в полях
    const regex = /[^A-Za-zА-Яа-я0-9\s\-]/g;
    const fields = ['name', 'publishingCompany'];

    fields.forEach(function(id) {
      const input = document.getElementById(id);
      if (input) {
        input.addEventListener('input', function() {
          this.value = this.value.replace(regex, '');
        });
      }
    });

    // 2. Ограничение даты до текущего дня
    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const year = today.getFullYear();
    const formattedDate = `${year}-${month}-${day}`;

    const dateInput = document.getElementById('publicationYear');
    if (dateInput) {
      dateInput.setAttribute('max', formattedDate);
    }

    // 3. Валидация ISBN-13
    const isbnInput = document.getElementById('isbn');

    function formatISBN(value) {
      let digits = value.replace(/\D/g, '');
      if (digits.length > 13) digits = digits.substring(0, 13);
      const parts = [];
      let index = 0;

      if (digits.length > 3) {
        parts.push(digits.substring(0, 3));
        index = 3;
      } else {
        parts.push(digits);
        return parts.join('-');
      }

      if (digits.length > 4) {
        parts.push(digits.substring(3, 4));
        index = 4;
      } else {
        parts.push(digits.substring(3));
        return parts.join('-');
      }

      if (digits.length > 6) {
        parts.push(digits.substring(4, 6));
        index = 6;
      } else {
        parts.push(digits.substring(4));
        return parts.join('-');
      }

      if (digits.length > 12) {
        parts.push(digits.substring(6, 12));
        index = 12;
      } else {
        parts.push(digits.substring(6));
        return parts.join('-');
      }

      if (digits.length > 12) {
        parts.push(digits.substring(12, 13));
      }

      return parts.join('-');
    }

    function onInputISBN(event) {
      const input = event.target;
      const formattedValue = formatISBN(input.value);
      input.value = formattedValue;
      input.setSelectionRange(input.value.length, input.value.length);
    }

    function restrictISBNInput(event) {
      const allowedKeys = ['Backspace', 'ArrowLeft', 'ArrowRight', 'Delete', 'Tab'];
      if (allowedKeys.includes(event.key)) return;
      if (!/^\d$/.test(event.key)) event.preventDefault();
    }

    if (isbnInput) {
      isbnInput.addEventListener('input', onInputISBN);
      isbnInput.addEventListener('keydown', restrictISBNInput);
    }

    // 4. Функциональность для динамического добавления и удаления авторов
    const authorsContainer = document.getElementById('authors-container');
    const addAuthorBtn = document.querySelector('.add-author-btn');

    addAuthorBtn.addEventListener('click', function() {
      const authorGroup = document.createElement('div');
      authorGroup.classList.add('author-group');

      const removeBtn = document.createElement('span');
      removeBtn.classList.add('remove-author');
      removeBtn.innerHTML = '&times;';
      removeBtn.style.display = 'block';
      removeBtn.addEventListener('click', function() {
        authorsContainer.removeChild(authorGroup);
      });

      authorGroup.appendChild(removeBtn);

      // ФИО автора
      const fioGroup = document.createElement('div');
      fioGroup.classList.add('u-form-group');
      const fioLabel = document.createElement('label');
      fioLabel.setAttribute('for', 'authorFio');
      fioLabel.classList.add('u-label');
      fioLabel.textContent = 'ФИО автора';
      const fioInput = document.createElement('input');
      fioInput.type = 'text';
      fioInput.placeholder = 'Введите ФИО автора';
      fioInput.name = 'authorFio';
      fioInput.classList.add('u-input', 'author-fio');
      fioInput.required = true;
      fioInput.pattern = '[A-Za-zА-Яа-яЁё\\s\\-]+';
      fioInput.title = 'Разрешены только буквы, пробелы и дефис (-)';
      fioGroup.appendChild(fioLabel);
      fioGroup.appendChild(fioInput);

      // Список подсказок для автора
      const suggestionsList = document.createElement('ul');
      suggestionsList.classList.add('author-suggestions-list');
      suggestionsList.style.display = 'none';
      fioGroup.appendChild(suggestionsList);

      // Скрытое поле для хранения ID автора
      const authorIdInput = document.createElement('input');
      authorIdInput.type = 'hidden';
      authorIdInput.name = 'authorId';
      authorIdInput.classList.add('author-id');
      fioGroup.appendChild(authorIdInput);

      authorGroup.appendChild(fioGroup);

      authorsContainer.appendChild(authorGroup);

      // Добавляем обработчики для нового поля ФИО автора
      addAuthorFioListener(fioInput, suggestionsList, authorIdInput);
    });

    // 5. Функциональность для подсказок авторов из базы данных
    function showAuthorSuggestions(inputElement, suggestionsListElement, authorIdInput) {
      const query = inputElement.value.trim();
      if (query.length === 0) {
        suggestionsListElement.innerHTML = '';
        suggestionsListElement.style.display = 'none';
        return;
      }

      console.log(`Запрос к авторам: ${query}`); // Логирование запроса

      // Отправка AJAX-запроса на сервер для поиска авторов
      fetch(`/api/authors/search?q=${encodeURIComponent(query)}`)
        .then(response => {
          console.log('Получен ответ для авторов:', response); // Логирование ответа
          return response.json();
        })
        .then(data => {
          console.log('Данные авторов:', data); // Логирование полученных данных
          suggestionsListElement.innerHTML = '';
          if (data.length === 0) {
            const noResultItem = document.createElement('li');
            noResultItem.textContent = 'Автор не найден. Можно добавить нового.';
            noResultItem.style.cursor = 'default';
            suggestionsListElement.appendChild(noResultItem);
            suggestionsListElement.style.display = 'block';
            return;
          }

          data.forEach(author => {
            const listItem = document.createElement('li');
            // Используем 'fio' и добавляем 'nickname', если он есть
            listItem.textContent = `${author.fio}${author.nickname ? ' (' + author.nickname + ')' : ''}, ${author.birthDate || '---'}, ${author.country || '---'}`;
            listItem.addEventListener('click', function() {
              inputElement.value = author.fio;
              authorIdInput.value = author.id; // Сохраняем ID автора
              suggestionsListElement.innerHTML = '';
              suggestionsListElement.style.display = 'none';
            });
            suggestionsListElement.appendChild(listItem);
          });
          suggestionsListElement.style.display = 'block';
        })
        .catch(error => {
          console.error('Ошибка при получении подсказок авторов:', error);
        });
    }

    function addAuthorFioListener(inputElement, suggestionsListElement, authorIdInput) {
      inputElement.addEventListener('input', function() {
        showAuthorSuggestions(inputElement, suggestionsListElement, authorIdInput);
      });

      // Закрытие списка подсказок при клике вне поля
      document.addEventListener('click', function(event) {
        if (!inputElement.contains(event.target) && !suggestionsListElement.contains(event.target)) {
          suggestionsListElement.innerHTML = '';
          suggestionsListElement.style.display = 'none';
        }
      });
    }

    // Инициализируем обработчики для существующих полей ФИО автора
    const initialAuthorInputs = document.querySelectorAll('.author-fio');
    const initialAuthorSuggestions = document.querySelectorAll('.author-suggestions-list');
    const initialAuthorIds = document.querySelectorAll('.author-id');

    initialAuthorInputs.forEach((input, index) => {
      const suggestionsListElement = initialAuthorSuggestions[index];
      const authorIdInput = initialAuthorIds[index];
      addAuthorFioListener(input, suggestionsListElement, authorIdInput);
    });

    // 6. Валидация Жанра с Тэгами
    const genreInput = document.getElementById('genre-input');
    const genreTagsContainer = document.getElementById('genre-tags');
    const genresHiddenInput = document.getElementById('genres-hidden'); // Скрытое поле

    // Удаление статического списка доступных жанров
    // const availableGenres = [...]; // Статический список удалён

    // Функция для создания тэга
    function createTag(text) {
      if (!text.trim()) return;

      // Проверка на дублирование
      const existingGenres = Array.from(genreTagsContainer.children).map(tag => tag.firstChild.textContent.trim().toLowerCase());
      if (existingGenres.includes(text.trim().toLowerCase())) return;

      const tag = document.createElement('span');
      tag.classList.add('tag');

      const tagText = document.createElement('span');
      tagText.textContent = text.trim();

      const removeBtn = document.createElement('span');
      removeBtn.classList.add('remove-tag');
      removeBtn.textContent = '×';
      removeBtn.addEventListener('click', function() {
        genreTagsContainer.removeChild(tag);
        updateGenresHiddenInput();
      });

      tag.appendChild(tagText);
      tag.appendChild(removeBtn);
      genreTagsContainer.appendChild(tag);
      updateGenresHiddenInput();
    }

    // Функция для обновления скрытого поля с жанрами
    function updateGenresHiddenInput() {
      const tags = Array.from(genreTagsContainer.children).map(tag => tag.firstChild.textContent);
      genresHiddenInput.value = tags.join(',');
    }

    // Разрешаем ввод только букв и пробелов
    genreInput.addEventListener('input', function() {
      this.value = this.value.replace(/[^A-Za-zА-Яа-яЁё\s]/g, '');
    });

    // Функция для создания списка подсказок на основе запроса
    function showGenreSuggestions(query) {
      if (query.length === 0) {
        removeGenreSuggestions();
        return;
      }

      fetch(`/api/styles/search?q=${encodeURIComponent(query)}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Сбой при поиске жанров');
          }
          return response.json();
        })
        .then(data => {
          const filteredGenres = data
            .map(style => style.name)
            .filter(genre => !Array.from(genreTagsContainer.children).some(tag => tag.firstChild.textContent.toLowerCase() === genre.toLowerCase()));

          createGenreSuggestionsList(filteredGenres);
        })
        .catch(error => {
          console.error('Ошибка при получении подсказок жанров:', error);
        });
    }

    // Функция для создания списка подсказок
    function createGenreSuggestionsList(filteredGenres) {
      // Удаление предыдущих подсказок
      removeGenreSuggestions();

      if (filteredGenres.length === 0) return;

      const list = document.createElement('ul');
      list.id = 'genre-suggestions';
      list.classList.add('suggestions-list');

      filteredGenres.forEach(genre => {
        const listItem = document.createElement('li');
        listItem.textContent = genre;
        listItem.addEventListener('click', function() {
          createTag(genre);
          genreInput.value = '';
          removeGenreSuggestions();
        });
        list.appendChild(listItem);
      });

      genreInput.parentElement.appendChild(list);
    }

    // Функция для удаления списка подсказок
    function removeGenreSuggestions() {
      const existingList = document.getElementById('genre-suggestions');
      if (existingList) {
        existingList.remove();
      }
    }

    // Обработчик ввода в поле жанра
    genreInput.addEventListener('input', function() {
      const query = this.value.trim();
      if (query.length === 0) {
        removeGenreSuggestions();
        return;
      }
      showGenreSuggestions(query);
    });

    // Закрытие подсказок при клике вне поля
    document.addEventListener('click', function (event) {
      if (!genreInput.contains(event.target) && !genreTagsContainer.contains(event.target)) {
        removeGenreSuggestions();
      }
    });

    // Обработка нажатия клавиши Enter для добавления жанра
    genreInput.addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        const genre = this.value.trim();
        if (genre !== '') { // Разрешаем добавление любых жанров, вне зависимости от списка
          createTag(genre);
          this.value = '';
          removeGenreSuggestions();
        }
      }
    });

    // 7. Функциональность для отправки формы через AJAX
    const form = document.getElementById('book-add-form');

    form.addEventListener('submit', function(event) {
      event.preventDefault(); // Предотвращаем стандартную отправку формы

      // Собираем данные из формы
      const formData = new FormData(form);

      // ISBN
      const isbn = formData.get('isbn').trim();

      // Название
      const name = formData.get('name').trim();

      // Год публикации
      const publicationYear = formData.get('publicationYear').trim();

      // Возрастное ограничение
      const ageLimit = parseFloat(formData.get('ageLimit'));

      // Издатель
      const publishingCompany = formData.get('publishingCompany').trim();

      // Количество страниц
      const pageCount = parseInt(formData.get('pageCount'), 10);

      // Язык
      const language = formData.get('language').trim();

      // Цена
      const cost = parseFloat(formData.get('cost'));

      // Количество книг
      const countOfBooks = parseInt(formData.get('countOfBooks'), 10);

      // Авторы
      const authorFios = form.querySelectorAll('input[name="authorFio"]');
      const authorIds = form.querySelectorAll('input[name="authorId"]');

      const authors = [];
      for (let i = 0; i < authorFios.length; i++) {
        const author = {
          // Если выбран существующий автор, используем его ID, иначе null
          id: authorIds[i].value.trim() !== '' ? parseInt(authorIds[i].value.trim(), 10) : null,
          fio: authorFios[i].value.trim(),
          // Дополнительно можно добавить поля birthDate, country, nickname, если необходимо
        };
        authors.push(author);
      }

      // Жанры
      const genres = formData.get('genres').split(',').map(genre => genre.trim()).filter(genre => genre.length > 0);

      // Проверка наличия хотя бы одного жанра
      if (genres.length === 0) {
        alert('Пожалуйста, добавьте хотя бы один жанр.');
        return;
      }

      // Формируем объект для отправки
      const bookDTO = {
        isbn: isbn,
        name: name,
        publicationYear: publicationYear,
        ageLimit: ageLimit,
        publishingCompany: publishingCompany,
        pageCount: pageCount,
        language: language,
        cost: cost,
        countOfBooks: countOfBooks,
        authors: authors,
        genres: genres
      };

      console.log('Отправляемые данные:', bookDTO); // Логирование данных

      // Отправка данных на сервер через Fetch API
      fetch('/api/books', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(bookDTO)
      })
      .then(response => {
        if (response.ok) {
          // Показываем сообщение об успехе
          document.querySelector('.u-form-send-success').style.display = 'block';
          document.querySelector('.u-form-send-error').style.display = 'none';
          form.reset();
          // Очистка тегов жанров
          genreTagsContainer.innerHTML = '';
          genresHiddenInput.value = '';
          // Удаление дополнительных авторов, оставляем только первый
          const authorGroups = document.querySelectorAll('.author-group');
          authorGroups.forEach((group, index) => {
            if (index > 0) {
              group.remove();
            } else {
              // Очистка полей первого автора и скрытых ID
              group.querySelectorAll('input.author-fio').forEach(input => input.value = '');
              group.querySelectorAll('input.author-id').forEach(input => input.value = '');
            }
          });
        } else {
          // Показываем сообщение об ошибке
          document.querySelector('.u-form-send-success').style.display = 'none';
          document.querySelector('.u-form-send-error').style.display = 'block';
        }
      })
      .catch(error => {
        console.error('Ошибка при отправке формы:', error);
        document.querySelector('.u-form-send-success').style.display = 'none';
        document.querySelector('.u-form-send-error').style.display = 'block';
      });
    });

    // 8. Функциональность для подсказок издательств из базы данных
    function showPublishingCompanySuggestions(inputElement, suggestionsListElement) {
      const query = inputElement.value.trim();
      if (query.length === 0) {
        suggestionsListElement.innerHTML = '';
        suggestionsListElement.style.display = 'none';
        return;
      }

      console.log(`Запрос к издательствам: ${query}`); // Логирование запроса

      // Отправка AJAX-запроса на сервер для поиска издательств
      fetch(`/api/publishing-companies/search?q=${encodeURIComponent(query)}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Сбой при поиске издательств');
          }
          console.log('Получен ответ для издательств:', response); // Логирование ответа
          return response.json();
        })
        .then(data => {
          console.log('Данные издательств:', data); // Логирование полученных данных
          suggestionsListElement.innerHTML = '';
          if (data.length === 0) {
            const noResultItem = document.createElement('li');
            noResultItem.textContent = 'Издательство не найдено. Можно добавить новое.';
            noResultItem.style.cursor = 'default';
            suggestionsListElement.appendChild(noResultItem);
            suggestionsListElement.style.display = 'block';
            return;
          }

          data.forEach(company => {
            const listItem = document.createElement('li');
            listItem.textContent = company.name;
            listItem.addEventListener('click', function() {
              inputElement.value = company.name;
              suggestionsListElement.innerHTML = '';
              suggestionsListElement.style.display = 'none';
            });
            suggestionsListElement.appendChild(listItem);
          });
          suggestionsListElement.style.display = 'block';
        })
        .catch(error => {
          console.error('Ошибка при получении подсказок издательств:', error);
        });
    }

    // Добавляем обработчик для поля издательства
    const publishingCompanyInput = document.getElementById('publishingCompany');
    const publishingCompanySuggestions = document.getElementById('publishingCompany-suggestions');

    if (publishingCompanyInput && publishingCompanySuggestions) {
      publishingCompanyInput.addEventListener('input', function() {
        showPublishingCompanySuggestions(publishingCompanyInput, publishingCompanySuggestions);
      });

      // Закрытие списка подсказок при клике вне поля
      document.addEventListener('click', function(event) {
        if (!publishingCompanyInput.contains(event.target) && !publishingCompanySuggestions.contains(event.target)) {
          publishingCompanySuggestions.innerHTML = '';
          publishingCompanySuggestions.style.display = 'none';
        }
      });
    }
  });
</script>

</body>
</html>
