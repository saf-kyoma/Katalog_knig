<!DOCTYPE html>
<html style="font-size: 16px;" lang="ru">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">
  <title>Редактирование книги</title>
  <link rel="stylesheet" href="nicepage.css" media="screen">
  <link rel="stylesheet" href="Редакт-книги.css" media="screen">
  <!-- Подключение Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <!-- Подключение jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha384-KyZXEAg3QhqLMpG8r+8jhAXgPItkL5oH+05CLT1X4mUy25LKjOjljjbyheL2EMlM" crossorigin="anonymous" defer></script>
  <!-- Подключение Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous" defer></script>
  <meta name="theme-color" content="#2cccc4">

  <style>
    /* Основные стили формы */
    .u-form-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 15px;
      position: relative;
    }

    .u-label {
      font-weight: bold;
      margin-bottom: 5px;
      text-align: left;
    }

    .u-input, .u-input-number, .u-select {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* Стили для тегов жанров */
    .tags-input-container {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 5px;
      align-items: center;
      position: relative;
    }

    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }

    .tag {
      background-color: #3498db;
      color: white;
      padding: 5px 10px;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      font-size: 14px;
      font-family: Arial, sans-serif;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: background-color 0.3s ease;
    }

    .tag:hover {
      background-color: #2980b9;
    }

    .remove-tag {
      margin-left: 8px;
      cursor: pointer;
      font-weight: bold;
      color: #ffffff;
      transition: color 0.3s ease;
    }

    .remove-tag:hover {
      color: #ff0000;
    }

    /* Стили для списков подсказок */
    .suggestions-list {
      position: absolute;
      background-color: white;
      border: 1px solid #ccc;
      border-top: none;
      width: 100%;
      max-height: 150px;
      overflow-y: auto;
      z-index: 1000;
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .suggestions-list li {
      padding: 8px;
      cursor: pointer;
    }

    .suggestions-list li:hover {
      background-color: #f0f0f0;
    }

    .author-suggestions-list {
      position: absolute;
      background-color: white;
      border: 1px solid #ccc;
      border-top: none;
      width: 100%;
      max-height: 150px;
      overflow-y: auto;
      z-index: 1000;
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .author-suggestions-list li {
      padding: 8px;
      cursor: pointer;
    }

    .author-suggestions-list li:hover {
      background-color: #f0f0f0;
    }

    /* Стили для динамических групп авторов */
    .author-group {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
      position: relative;
    }

    .remove-author {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
      color: red;
      font-weight: bold;
      display: none; /* Скрыто для первого автора */
      font-size: 18px;
      z-index: 1001;
    }

    .author-group:hover .remove-author {
      display: block;
    }

    .add-author-btn {
      padding: 8px 12px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .add-author-btn:hover {
      background-color: #2980b9;
    }

    /* Стили для кнопок */
    .buttons-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }

    .u-btn {
      flex: 0 1 auto;
      min-width: 120px;
      max-width: 200px;
      text-align: center;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }

    .u-btn-submit {
      background-color: #2ecc71;
      color: white;
    }

    .u-btn-submit:hover {
      background-color: #27ae60;
    }

    .u-btn-cancel {
      background-color: #e74c3c;
      color: white;
      text-decoration: none;
      display: inline-block;
    }

    .u-btn-cancel:hover {
      background-color: #c0392b;
    }

    /* Стили для сообщений */
    .u-form-send-message {
      display: none;
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
      font-weight: bold;
    }

    .u-form-send-success {
      background-color: #2ecc71;
      color: white;
    }

    .u-form-send-error {
      background-color: #e74c3c;
      color: white;
    }

    /* Стили для страницы */
    .u-sheet {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    .u-text-1 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 24px;
      font-weight: bold;
      writing-mode: horizontal-tb;
      transform: rotate(0deg);
    }

    /* Медиа-запросы для адаптивности */
    @media (max-width: 768px) {
      .buttons-container {
        flex-direction: column;
      }

      .u-btn {
        width: 100%;
        max-width: none;
      }
    }
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f4;
    }

    header {
        background-color: #2cccc4;
        color: #fff;
        padding: 10px 20px;
        text-align: center;
    }



    .container {
        margin: 20px auto;
        max-width: 800px;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }

    table th, table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
        width: 25%; /* Каждая колонка равной ширины */
    }

    table th {
        background-color: #2cccc4;
        color: white;
        text-transform: uppercase;
    }

    table tr:nth-child(even) {
        background-color: #f9f9f9;
    }



    .btn {
        display: inline-block;
        padding: 10px 15px;
        margin: 5px;
        border: none;
        border-radius: 5px;
        background-color: #2cccc4;
        color: #fff;
        text-decoration: none;
        text-align: center;
    }

    .btn:hover {
        background-color: #249a9a;
    }

    /* (Существующие стили остаются без изменений) */
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f4;
    }

    header {
        background-color: #2cccc4;
        color: #fff;
        padding: 10px 20px;
        text-align: center;
    }

    nav {
        background-color: #249a9a;
        padding: 10px;
    }

    nav ul {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
    }

    nav ul li {
        margin: 0 15px;
    }

    nav ul li a {
        color: white;
        text-decoration: none;
        font-weight: bold;
    }

    nav ul li a:hover {
        text-decoration: underline;
    }

    .container {
        margin: 20px auto;
        max-width: 800px;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }

    table th, table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }

    table th {
        background-color: #2cccc4;
        color: white;
        text-transform: uppercase;
    }

    table tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    .btn {
        display: inline-block;
        padding: 10px 15px;
        margin: 5px;
        border: none;
        border-radius: 5px;
        background-color: #2cccc4;
        color: #fff;
        text-decoration: none;
        text-align: center;
        cursor: pointer;
    }

    .btn:hover {
        background-color: #249a9a;
    }

    .sort-button {
        background: none;
        border: none;
        padding: 0;
        margin-left: 5px;
        cursor: pointer;
        font-size: 14px;
        user-select: none;
    }

    .sort-button:focus {
        outline: none;
    }

    footer {
        background-color: #f1f1f1;
        padding: 20px 0;
        text-align: center;
    }

    .u-backlink {
        background-color: #f1f1f1;
        padding: 10px 0;
        text-align: center;
    }

    /* Дополнительные стили для формы поиска и кнопок */
    .search-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    .search-container .input-group {
        flex: 1 1 auto;
        min-width: 250px;
    }

    .search-buttons {
        display: flex;
        gap: 10px;
    }

    @media (max-width: 576px) {
        .search-container {
            flex-direction: column;
            align-items: stretch;
        }

        .search-container .input-group,
        .search-buttons {
            width: 100%;
            justify-content: center;
        }

        .search-buttons {
            justify-content: flex-start;
        }
    }

    /* Стили для чекбоксов */
    .checkbox-column {
        text-align: center;
        width: 50px; /* Фиксированная ширина для чекбоксов */
    }

    .checkbox-column input[type="checkbox"] {
        transform: scale(1.2); /* Увеличение размера чекбокса для лучшей видимости */
    }

    /* Общий стиль навигации */
    nav.u-menu {
        background-color: #249a9a;
        display: flex;
        justify-content: center;
        padding: 10px;
    }

    nav.u-menu ul {
        list-style: none;
        display: flex;
        padding: 0;
        margin: 0;
    }

    nav.u-menu ul li {
        position: relative;
        margin: 0 10px;
    }

    nav.u-menu ul li a {
        color: white;
        text-decoration: none;
        padding: 10px 20px;
        display: block;
    }

    nav.u-menu ul li a:hover {
        background-color: #2cccc4;
        border-radius: 5px;
    }

    /* Стили для выпадающего меню */
    nav.u-menu .dropdown {
        position: relative;
    }

    nav.u-menu .dropdown-menu {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        background-color: #fff;
        padding: 10px 0;
        list-style: none;
        margin: 0;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
        border-radius: 5px;
        z-index: 10;
    }

    nav.u-menu .dropdown-menu li {
        margin: 0;
    }

    nav.u-menu .dropdown-menu li a {
        color: #249a9a;
        padding: 10px 20px;
        display: block;
        text-align: left;
    }

    nav.u-menu .dropdown-menu li a:hover {
        background-color: #2cccc4;
        color: white;
    }

    /* Показываем меню при наведении */
    nav.u-menu .dropdown:hover .dropdown-menu {
        display: block;
    }

  </style>
</head>
<body class="u-body u-xl-mode" data-lang="ru">
<header>
  <h1>Редактирование книги</h1>
</header>
<nav class="u-dropdown-icon u-menu u-menu-dropdown u-menu-1 d-flex justify-content-center w-100" data-responsive-from="XS" data-submenu-level="on-click">
  <ul class="d-flex justify-content-center w-100">
    <li class="mx-2 flex-fill text-center"><a href="Каталог.html">Каталог</a></li>
    <li class="mx-2 flex-fill text-center"><a href="Страница-авторов.html">Авторы</a></li>
    <li class="mx-2 flex-fill text-center"><a href="Страница-издательств.html">Издательства</a></li>
    <li class="mx-2 flex-fill text-center"><a href="Вход-в-систему.html">Войти</a></li>
    <li class="dropdown mx-2 flex-fill text-center">
      <a href="#" class="dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">База данных</a>
      <ul class="dropdown-menu">
        <li><button id="DBadd" class="btn dropdown-item">Загрузить базу данных</button></li>
        <li><button id="DBout" class="btn dropdown-item">Выгрузить базу данных</button></li>
      </ul>
    </li>
  </ul>
</nav>

<section class="u-clearfix u-section-1" id="sec-64ce">
  <!-- Форма редактирования книги -->
  <div class="container">
    <form id="book-edit-form" class="u-clearfix u-form-spacing-10 u-form-vertical u-inner-form">
      <!-- ISBN -->
      <div class="u-form-group">
        <label for="isbn" class="u-label">ISBN</label>
        <input
                type="text"
                id="isbn"
                name="isbn"
                class="u-input"
                placeholder="978-0-00-000000-0"
                maxlength="17"
                title="Введите ISBN-13 в формате 978-0-00-000000-0"
                required
                readonly
        >
      </div>

      <!-- Название книги -->
      <div class="u-form-group">
        <label for="name" class="u-label">Название</label>
        <input type="text" placeholder="Введите название книги" id="name" name="name" class="u-input" required pattern="[A-Za-zА-Яа-я0-9\s\-]+" title="Разрешены только буквы, цифры, пробелы и дефис (-)">
      </div>

      <!-- Год публикации -->
      <div class="u-form-group">
        <label for="publicationYear" class="u-label">Год</label>
        <input type="date" id="publicationYear" name="publicationYear" class="u-input-number" required>
      </div>

      <!-- Возрастное ограничение -->
      <div class="u-form-group">
        <label for="ageLimit" class="u-label">Возрастное ограничение</label>
        <select id="ageLimit" name="ageLimit" class="u-input" required>
          <option value="" disabled>Выберите возрастное ограничение</option>
          <option value="0">0+</option>
          <option value="6">6+</option>
          <option value="12">12+</option>
          <option value="16">16+</option>
          <option value="18">18+</option>
        </select>
      </div>

      <!-- Издатель -->
      <div class="u-form-group" style="position: relative;">
        <label for="publishingCompany" class="u-label">Издатель</label>
        <input
                type="text"
                placeholder="Введите название издательства"
                id="publishingCompany"
                name="publishingCompany"
                class="u-input"
                required
                pattern="[A-Za-zА-Яа-я0-9\s\-]+"
                title="Разрешены только буквы, цифры, пробелы и дефис (-)"
                autocomplete="off"
        >
        <!-- Список подсказок -->
        <ul id="publishingCompany-suggestions" class="suggestions-list" style="display: none;"></ul>
      </div>

      <!-- Количество страниц -->
      <div class="u-form-group">
        <label for="pageCount" class="u-label">Страницы</label>
        <input type="number" id="pageCount" name="pageCount" class="u-input-number" value="1" min="1" max="10000" step="1" required>
      </div>

      <!-- Язык -->
      <div class="u-form-group">
        <label for="language" class="u-label">Язык</label>
        <select id="language" name="language" class="u-input" required>
          <option value="" disabled>Выберите язык</option>
          <option value="Русский">Русский</option>
          <option value="Английский">Английский</option>
          <option value="Немецкий">Немецкий</option>
          <option value="Китайский">Китайский</option>
          <option value="Японский">Японский</option>
          <option value="Португальский">Португальский</option>
          <option value="Испанский">Испанский</option>
          <option value="Итальянский">Итальянский</option>
          <option value="Польский">Польский</option>
        </select>
      </div>

      <!-- Цена -->
      <div class="u-form-group">
        <label for="cost" class="u-label">Цена</label>
        <input type="number" id="cost" name="cost" class="u-input-number" min="0" step="0.01" required placeholder="Введите цену">
      </div>

      <!-- Количество книг -->
      <div class="u-form-group">
        <label for="countOfBooks" class="u-label">Кол-во</label>
        <input type="number" id="countOfBooks" name="countOfBooks" class="u-input-number" value="0" min="0" max="10000" step="1" required>
      </div>

      <!-- Авторы -->
      <div class="u-form-group">
        <label class="u-label">Авторы</label>
        <div id="authors-container">
          <div class="author-group">
            <span class="remove-author">&times;</span>
            <div class="u-form-group">
              <label for="authorFio0" class="u-label">ФИО автора</label>
              <input type="text" placeholder="Введите ФИО автора" id="authorFio0" name="authorFio" class="u-input author-fio" required pattern="[A-Za-zА-Яа-яЁё\s\-]+" title="Разрешены только буквы, пробелы и дефис (-)">
              <ul class="author-suggestions-list" style="display: none;"></ul>
              <input type="hidden" name="authorId" class="author-id">
            </div>
          </div>
        </div>
        <button type="button" class="add-author-btn">Добавить автора</button>
      </div>

      <!-- Жанры -->
      <div class="u-form-group">
        <label for="genre-input" class="u-label">Жанры</label>
        <div class="tags-input-container">
          <div id="genre-tags" class="tags-container"></div>
          <input type="text" id="genre-input" class="u-input" placeholder="Введите жанр и нажмите Enter">
        </div>
      </div>

      <!-- Кнопки Редактирования и отмены -->
      <div class="buttons-container">
        <!-- Кнопка Редактирования -->
        <button type="submit" class="u-btn u-btn-submit">Редактировать</button>
        <!-- Кнопка Отмены -->
        <a href="Каталог.html" class="u-btn u-btn-cancel">Отмена</a>
      </div>

      <!-- Сообщения об отправке -->
      <div class="u-form-send-message u-form-send-success">Спасибо! Ваша книга обновлена.</div>
      <div class="u-form-send-error u-form-send-message">Отправка не удалась. Пожалуйста, исправьте ошибки и попробуйте еще раз.</div>

      <!-- Скрытые поля -->
      <input type="hidden" value="" name="recaptchaResponse">
      <input type="hidden" name="formServices" value="234d2f51-51fe-7107-fa98-0d7a5e49113d">
    </form>
  </div>
</section>

<!-- Подвал сайта -->
<footer class="u-align-center u-clearfix u-footer u-grey-80 u-footer" id="sec-2f71">
  <div class="u-clearfix u-sheet u-sheet-1">
    <p class="u-small-text u-text u-text-variant u-text-1">
      О вопросах и проблемах сообщать главному администратору или писать на почту <a href="mailto:GlobalMaster@book.com">GlobalMaster@book.com</a>
    </p>
  </div>
</footer>

<!-- Скрипты валидации и функциональности -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 1. Очистка нежелательных символов в полях
    const regex = /[^A-Za-zА-Яа-я0-9\s\-]/g;
    const fields = ['name', 'publishingCompany'];

    fields.forEach(function(id) {
      const input = document.getElementById(id);
      if (input) {
        input.addEventListener('input', function() {
          this.value = this.value.replace(regex, '');
        });
      }
    });

    // 2. Ограничение даты до текущего дня
    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const year = today.getFullYear();
    const formattedDate = `${year}-${month}-${day}`;

    const dateInput = document.getElementById('publicationYear');
    if (dateInput) {
      dateInput.setAttribute('max', formattedDate);
    }

    // 3. Удалена валидация ISBN-13, так как поле readonly

    // 4. Функциональность для динамического добавления и удаления авторов
    const authorsContainer = document.getElementById('authors-container');
    const addAuthorBtn = document.querySelector('.add-author-btn');
    let authorCounter = 1; // Счетчик для уникальных ID авторов

    addAuthorBtn.addEventListener('click', function() {
      const authorGroup = document.createElement('div');
      authorGroup.classList.add('author-group');

      const removeBtn = document.createElement('span');
      removeBtn.classList.add('remove-author');
      removeBtn.innerHTML = '&times;';
      removeBtn.style.display = 'block';
      removeBtn.addEventListener('click', function() {
        authorsContainer.removeChild(authorGroup);
      });

      authorGroup.appendChild(removeBtn);

      // ФИО автора
      const fioGroup = document.createElement('div');
      fioGroup.classList.add('u-form-group');

      const uniqueId = `authorFio${authorCounter}`;

      const fioLabel = document.createElement('label');
      fioLabel.setAttribute('for', uniqueId);
      fioLabel.classList.add('u-label');
      fioLabel.textContent = 'ФИО автора';

      const fioInput = document.createElement('input');
      fioInput.type = 'text';
      fioInput.placeholder = 'Введите ФИО автора';
      fioInput.name = 'authorFio';
      fioInput.classList.add('u-input', 'author-fio');
      fioInput.required = true;
      fioInput.pattern = '[A-Za-zА-Яа-яЁё\\s\\-]+';
      fioInput.title = 'Разрешены только буквы, пробелы и дефис (-)';
      fioInput.id = uniqueId;

      fioGroup.appendChild(fioLabel);
      fioGroup.appendChild(fioInput);

      // Список подсказок для автора
      const suggestionsList = document.createElement('ul');
      suggestionsList.classList.add('author-suggestions-list');
      suggestionsList.style.display = 'none';
      fioGroup.appendChild(suggestionsList);

      // Скрытое поле для хранения ID автора
      const authorIdInput = document.createElement('input');
      authorIdInput.type = 'hidden';
      authorIdInput.name = 'authorId';
      authorIdInput.classList.add('author-id');
      fioGroup.appendChild(authorIdInput);

      authorGroup.appendChild(fioGroup);

      authorsContainer.appendChild(authorGroup);

      // Добавляем обработчики для нового поля ФИО автора
      addAuthorFioListener(fioInput, suggestionsList, authorIdInput);

      authorCounter++;
    });

    // 5. Функциональность для подсказок авторов из базы данных
    function showAuthorSuggestions(inputElement, suggestionsListElement, authorIdInput) {
      const query = inputElement.value.trim();
      if (query.length === 0) {
        suggestionsListElement.innerHTML = '';
        suggestionsListElement.style.display = 'none';
        return;
      }

      console.log(`Запрос к авторам: ${query}`); // Логирование запроса

      // Отправка AJAX-запроса на сервер для поиска авторов
      fetch(`/api/authors/search?q=${encodeURIComponent(query)}`)
        .then(response => {
          console.log('Получен ответ для авторов:', response); // Логирование ответа
          if (!response.ok) {
            throw new Error('Ошибка при поиске авторов');
          }
          return response.json();
        })
        .then(data => {
          console.log('Данные авторов:', data); // Логирование полученных данных
          suggestionsListElement.innerHTML = '';
          if (data.length === 0) {
            const noResultItem = document.createElement('li');
            noResultItem.textContent = 'Автор не найден. Можно добавить нового.';
            noResultItem.style.cursor = 'default';
            suggestionsListElement.appendChild(noResultItem);
            suggestionsListElement.style.display = 'block';
            return;
          }

          data.forEach(author => {
            const listItem = document.createElement('li');
            // Используем 'fio' и добавляем 'nickname', если он есть
            listItem.textContent = `${author.fio}${author.nickname ? ' (' + author.nickname + ')' : ''}, ${author.birthDate || '---'}, ${author.country || '---'}`;
            listItem.addEventListener('click', function() {
              inputElement.value = author.fio;
              authorIdInput.value = author.id; // Сохраняем ID автора
              suggestionsListElement.innerHTML = '';
              suggestionsListElement.style.display = 'none';
            });
            suggestionsListElement.appendChild(listItem);
          });
          suggestionsListElement.style.display = 'block';
        })
        .catch(error => {
          console.error('Ошибка при получении подсказок авторов:', error);
        });
    }

    function addAuthorFioListener(inputElement, suggestionsListElement, authorIdInput) {
      inputElement.addEventListener('input', function() {
        showAuthorSuggestions(inputElement, suggestionsListElement, authorIdInput);
      });

      // Закрытие списка подсказок при клике вне поля
      document.addEventListener('click', function(event) {
        if (!inputElement.contains(event.target) && !suggestionsListElement.contains(event.target)) {
          suggestionsListElement.innerHTML = '';
          suggestionsListElement.style.display = 'none';
        }
      });
    }

    // Инициализируем обработчики для существующих полей ФИО автора
    const initialAuthorInputs = document.querySelectorAll('.author-fio');
    const initialAuthorSuggestions = document.querySelectorAll('.author-suggestions-list');
    const initialAuthorIds = document.querySelectorAll('.author-id');

    initialAuthorInputs.forEach((input, index) => {
      const suggestionsListElement = initialAuthorSuggestions[index];
      const authorIdInput = initialAuthorIds[index];
      addAuthorFioListener(input, suggestionsListElement, authorIdInput);
    });

    // 6. Валидация Жанра с Тэгами
    const genreInput = document.getElementById('genre-input');
    const genreTagsContainer = document.getElementById('genre-tags');

    // Функция для создания тэга
    function createTag(text) {
      if (!text.trim()) return;

      // Проверка на дублирование
      const existingGenres = Array.from(genreTagsContainer.children).map(tag => tag.firstChild.textContent.trim().toLowerCase());
      if (existingGenres.includes(text.trim().toLowerCase())) return;

      const tag = document.createElement('span');
      tag.classList.add('tag');

      const tagText = document.createElement('span');
      tagText.textContent = text.trim();

      const removeBtn = document.createElement('span');
      removeBtn.classList.add('remove-tag');
      removeBtn.textContent = '×';
      removeBtn.addEventListener('click', function() {
        genreTagsContainer.removeChild(tag);
        updateGenresHiddenInput();
      });

      tag.appendChild(tagText);
      tag.appendChild(removeBtn);
      genreTagsContainer.appendChild(tag);
      updateGenresHiddenInput();
    }

    // Функция для обновления скрытого поля с жанрами (если необходимо)
    function updateGenresHiddenInput() {
      // Если вы всё ещё хотите хранить жанры в скрытом поле, но теперь как массив
      const genres = Array.from(genreTagsContainer.children).map(tag => tag.firstChild.textContent);
      // Здесь вы можете сохранить их в скрытом поле как JSON строку, если нужно
      // document.getElementById('genres-hidden').value = JSON.stringify(genres);
    }

    // Разрешаем ввод только букв и пробелов
    genreInput.addEventListener('input', function() {
      this.value = this.value.replace(/[^A-Za-zА-Яа-яЁё\s]/g, '');
    });

    // Функция для создания списка подсказок на основе запроса
    function showGenreSuggestions(query) {
      if (query.length === 0) {
        removeGenreSuggestions();
        return;
      }

      fetch(`/api/styles/search?q=${encodeURIComponent(query)}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Сбой при поиске жанров');
          }
          return response.json();
        })
        .then(data => {
          const filteredGenres = data
            .map(style => style.name)
            .filter(genre => !Array.from(genreTagsContainer.children).some(tag => tag.firstChild.textContent.toLowerCase() === genre.toLowerCase()));

          createGenreSuggestionsList(filteredGenres);
        })
        .catch(error => {
          console.error('Ошибка при получении подсказок жанров:', error);
        });
    }

    // Функция для создания списка подсказок
    function createGenreSuggestionsList(filteredGenres) {
      // Удаление предыдущих подсказок
      removeGenreSuggestions();

      if (filteredGenres.length === 0) return;

      const list = document.createElement('ul');
      list.id = 'genre-suggestions';
      list.classList.add('suggestions-list');

      filteredGenres.forEach(genre => {
        const listItem = document.createElement('li');
        listItem.textContent = genre;
        listItem.addEventListener('click', function() {
          createTag(genre);
          genreInput.value = '';
          removeGenreSuggestions();
        });
        list.appendChild(listItem);
      });

      genreInput.parentElement.appendChild(list);
    }

    // Функция для удаления списка подсказок
    function removeGenreSuggestions() {
      const existingList = document.getElementById('genre-suggestions');
      if (existingList) {
        existingList.remove();
      }
    }

    // Обработчик ввода в поле жанра
    genreInput.addEventListener('input', function() {
      const query = this.value.trim();
      if (query.length === 0) {
        removeGenreSuggestions();
        return;
      }
      showGenreSuggestions(query);
    });

    // Закрытие подсказок при клике вне поля
    document.addEventListener('click', function (event) {
      if (!genreInput.contains(event.target) && !genreTagsContainer.contains(event.target)) {
        removeGenreSuggestions();
      }
    });

    // Обработка нажатия клавиши Enter для добавления жанра
    genreInput.addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        const genre = this.value.trim();
        if (genre !== '') { // Разрешаем добавление любых жанров, вне зависимости от списка
          createTag(genre);
          this.value = '';
          removeGenreSuggestions();
        }
      }
    });

    ////// ИНТЕГРАЦИЯ РЕДАКТИРОВАНИЯ //////

    // Функция для получения параметра из URL
    function getParameterByName(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // Функция для получения данных книги по ISBN
    function fetchBookData(isbn) {
      fetch(`/api/books/${encodeURIComponent(isbn)}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Книга не найдена');
          }
          return response.json();
        })
        .then(data => {
          populateForm(data);
        })
        .catch(error => {
          console.error('Ошибка при загрузке данных книги:', error);
          alert('Не удалось загрузить данные книги. Проверьте ISBN и попробуйте снова.');
        });
    }

    // Функция для заполнения формы данными книги
    function populateForm(book) {
      document.getElementById('isbn').value = book.isbn || '';
      document.getElementById('name').value = book.name || '';
      document.getElementById('publicationYear').value = book.publicationYear ? book.publicationYear.substring(0,10) : '';
      document.getElementById('ageLimit').value = book.ageLimit || '';
      document.getElementById('publishingCompany').value = book.publishingCompany || '';
      document.getElementById('pageCount').value = book.pageCount || 1;
      document.getElementById('language').value = book.language || '';
      document.getElementById('cost').value = book.cost || 0;
      document.getElementById('countOfBooks').value = book.countOfBooks || 0;

      // Очистка существующих жанров перед добавлением
      genreTagsContainer.innerHTML = '';

      // Заполнение жанров
      if (book.genres && Array.isArray(book.genres)) {
        book.genres.forEach(genre => {
          createTag(genre);
        });
      }

      // Очистка существующих авторов перед добавлением
      // Оставляем только первый автор и удаляем остальные
      const existingAuthorGroups = authorsContainer.querySelectorAll('.author-group');
      existingAuthorGroups.forEach((group, index) => {
        if (index > 0) {
          authorsContainer.removeChild(group);
        }
      });

      // Заполнение первого автора
      const firstAuthor = book.authors[0];
      if (firstAuthor) {
        const firstAuthorInput = authorsContainer.querySelector('.author-fio');
        const firstAuthorIdInput = authorsContainer.querySelector('.author-id');
        firstAuthorInput.value = firstAuthor.fio || '';
        firstAuthorIdInput.value = firstAuthor.id || '';
      }

      // Добавляем остальных авторов
      for (let i = 1; i < book.authors.length; i++) {
        const author = book.authors[i];
        if (author) {
          addNewAuthor(author.fio, author.id);
        }
      }
    }

    // Функция для добавления нового автора в форму
    function addNewAuthor(fio, authorId) {
      const authorGroup = document.createElement('div');
      authorGroup.classList.add('author-group');

      const removeBtn = document.createElement('span');
      removeBtn.classList.add('remove-author');
      removeBtn.innerHTML = '&times;';
      removeBtn.style.display = 'block';
      removeBtn.addEventListener('click', function() {
        authorsContainer.removeChild(authorGroup);
      });

      authorGroup.appendChild(removeBtn);

      // ФИО автора
      const fioGroup = document.createElement('div');
      fioGroup.classList.add('u-form-group');

      const uniqueId = `authorFio${authorCounter}`;

      const fioLabel = document.createElement('label');
      fioLabel.setAttribute('for', uniqueId);
      fioLabel.classList.add('u-label');
      fioLabel.textContent = 'ФИО автора';

      const fioInput = document.createElement('input');
      fioInput.type = 'text';
      fioInput.placeholder = 'Введите ФИО автора';
      fioInput.name = 'authorFio';
      fioInput.classList.add('u-input', 'author-fio');
      fioInput.required = true;
      fioInput.pattern = '[A-Za-zА-Яа-яЁё\\s\\-]+';
      fioInput.title = 'Разрешены только буквы, пробелы и дефис (-)';
      fioInput.id = uniqueId;
      fioInput.value = fio || '';

      fioGroup.appendChild(fioLabel);
      fioGroup.appendChild(fioInput);

      // Список подсказок для автора
      const suggestionsList = document.createElement('ul');
      suggestionsList.classList.add('author-suggestions-list');
      suggestionsList.style.display = 'none';
      fioGroup.appendChild(suggestionsList);

      // Скрытое поле для хранения ID автора
      const authorIdInput = document.createElement('input');
      authorIdInput.type = 'hidden';
      authorIdInput.name = 'authorId';
      authorIdInput.classList.add('author-id');
      authorIdInput.value = authorId || '';
      fioGroup.appendChild(authorIdInput);

      authorGroup.appendChild(fioGroup);

      authorsContainer.appendChild(authorGroup);

      // Добавляем обработчики для нового поля ФИО автора
      addAuthorFioListener(fioInput, suggestionsList, authorIdInput);

      authorCounter++;
    }

    // Функция для обработки отправки формы
    function handleFormSubmit(event) {
      event.preventDefault();

      const form = event.target;
      const formData = new FormData(form);

      // Собираем данные книги
      const bookData = {
        isbn: formData.get('isbn'),
        name: formData.get('name'),
        publicationYear: formData.get('publicationYear'),
        ageLimit: formData.get('ageLimit'),
        publishingCompany: formData.get('publishingCompany'),
        pageCount: parseInt(formData.get('pageCount')),
        language: formData.get('language'),
        cost: parseFloat(formData.get('cost')),
        countOfBooks: parseInt(formData.get('countOfBooks')),
        genres: Array.from(genreTagsContainer.children).map(tag => tag.firstChild.textContent),
        authors: []
      };

      // Собираем авторов
      const authorFioInputs = form.querySelectorAll('.author-fio');
      const authorIdInputs = form.querySelectorAll('.author-id');

      authorFioInputs.forEach((fioInput, index) => {
        const fio = fioInput.value.trim();
        const authorId = authorIdInputs[index].value.trim();
        if (fio !== '') {
          bookData.authors.push({
            fio: fio,
            id: authorId || null
          });
        }
      });

      // Валидация наличия хотя бы одного автора
      if (bookData.authors.length === 0) {
        alert('Укажите хотя бы одного автора.');
        return;
      }

      // Отправка данных на сервер
      fetch(`/api/books/${encodeURIComponent(bookData.isbn)}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(bookData)
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('Ошибка при обновлении книги');
          }
          return response.json();
        })
        .then(data => {
          // Отображение успешного сообщения
          const successMsg = document.querySelector('.u-form-send-success');
          successMsg.style.display = 'block';
          successMsg.textContent = 'Спасибо! Ваша книга обновлена.';
          // Скрытие сообщения через 3 секунды
          setTimeout(() => {
            successMsg.style.display = 'none';
          }, 3000);
        })
        .catch(error => {
          console.error('Ошибка:', error);
          // Отображение ошибки
          const errorMsg = document.querySelector('.u-form-send-error');
          errorMsg.style.display = 'block';
          errorMsg.textContent = 'Отправка не удалась. Пожалуйста, исправьте ошибки и попробуйте еще раз.';
          // Скрытие сообщения через 3 секунды
          setTimeout(() => {
            errorMsg.style.display = 'none';
          }, 3000);
        });
    }

    // Добавляем обработчик отправки формы
    const bookEditForm = document.getElementById('book-edit-form');
    if (bookEditForm) {
      bookEditForm.addEventListener('submit', handleFormSubmit);
    }

    ////// ИНТЕГРАЦИЯ ПОДТЯГИВАНИЯ ДАННЫХ //////

    // Получаем ISBN из URL
    const isbnFromURL = getParameterByName('isbn');
    if (isbnFromURL) {
      fetchBookData(isbnFromURL);
    } else {
      alert('ISBN не указан в URL.');
    }

    // 8. Функциональность для подсказок издательств из базы данных
    function showPublishingCompanySuggestions(inputElement, suggestionsListElement) {
      const query = inputElement.value.trim();
      if (query.length === 0) {
        suggestionsListElement.innerHTML = '';
        suggestionsListElement.style.display = 'none';
        return;
      }

      console.log(`Запрос к издательствам: ${query}`); // Логирование запроса

      // Отправка AJAX-запроса на сервер для поиска издательств
      fetch(`/api/publishing-companies/search?q=${encodeURIComponent(query)}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Сбой при поиске издательств');
          }
          console.log('Получен ответ для издательств:', response); // Логирование ответа
          return response.json();
        })
        .then(data => {
          console.log('Данные издательств:', data); // Логирование полученных данных
          suggestionsListElement.innerHTML = '';
          if (data.length === 0) {
            const noResultItem = document.createElement('li');
            noResultItem.textContent = 'Издательство не найдено. Можно добавить новое.';
            noResultItem.style.cursor = 'default';
            suggestionsListElement.appendChild(noResultItem);
            suggestionsListElement.style.display = 'block';
            return;
          }

          data.forEach(company => {
            const listItem = document.createElement('li');
            listItem.textContent = company.name;
            listItem.addEventListener('click', function() {
              inputElement.value = company.name;
              suggestionsListElement.innerHTML = '';
              suggestionsListElement.style.display = 'none';
            });
            suggestionsListElement.appendChild(listItem);
          });
          suggestionsListElement.style.display = 'block';
        })
        .catch(error => {
          console.error('Ошибка при получении подсказок издательств:', error);
        });
    }

    // Добавляем обработчик для поля издательства
    const publishingCompanyInput = document.getElementById('publishingCompany');
    const publishingCompanySuggestions = document.getElementById('publishingCompany-suggestions');

    if (publishingCompanyInput && publishingCompanySuggestions) {
      publishingCompanyInput.addEventListener('input', function() {
        showPublishingCompanySuggestions(publishingCompanyInput, publishingCompanySuggestions);
      });

      // Закрытие списка подсказок при клике вне поля
      document.addEventListener('click', function(event) {
        if (!publishingCompanyInput.contains(event.target) && !publishingCompanySuggestions.contains(event.target)) {
          publishingCompanySuggestions.innerHTML = '';
          publishingCompanySuggestions.style.display = 'none';
        }
      });
    }
  });
</script>

</body>
</html>
