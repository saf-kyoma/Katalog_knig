<!DOCTYPE html>
<html style="font-size: 16px;" lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Каталог книг">
  <title>Каталог</title>

  <!-- Подключение Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

  <!-- Подключение пользовательских стилей -->
  <link rel="stylesheet" href="nicepage.css" media="screen">
  <link rel="stylesheet" href="index.css" media="screen">

  <!-- Подключение jQuery и Nicepage JS -->
  <script class="u-script" type="text/javascript" src="jquery.js" defer></script>
  <script class="u-script" type="text/javascript" src="nicepage.js" defer></script>

  <meta name="generator" content="Nicepage 7.1.0, nicepage.com">

  <!-- Подключение Google Fonts -->
  <link id="u-theme-google-font" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,100i,300,300i,400,400i,500,500i,700,700i,900,900i|Open+Sans:300,300i,400,400i,500,500i,600,600i,700,700i,800,800i">

  <meta name="theme-color" content="#2cccc4">
  <meta property="og:title" content="Каталог">
  <meta property="og:type" content="website">
  <meta data-intl-tel-input-cdn-path="intlTelInput/">

  <style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f4;
    }

    header {
        background-color: #2cccc4;
        color: #fff;
        padding: 10px 20px;
        text-align: center;
    }

    nav {
        background-color: #249a9a;
        padding: 10px;
    }

    nav ul {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
    }

    nav ul li {
        margin: 0 15px;
    }

    nav ul li a {
        color: white;
        text-decoration: none;
        font-weight: bold;
    }

    nav ul li a:hover {
        text-decoration: underline;
    }

    .container {
        margin: 20px auto;
        max-width: 1200px;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .btn {
        display: inline-block;
        padding: 10px 15px;
        margin: 5px;
        border: none;
        border-radius: 5px;
        background-color: #2cccc4;
        color: #fff;
        text-decoration: none;
        text-align: center;
    }

    .btn:hover {
        background-color: #249a9a;
    }

    .sort-button {
        background: none;
        border: none;
        padding: 0;
        margin-left: 5px;
        cursor: pointer;
        font-size: 14px;
        user-select: none;
    }

    .sort-button:focus {
        outline: none;
    }

    footer {
        background-color: #f1f1f1;
        padding: 20px 0;
        text-align: center;
    }

    .u-backlink {
        background-color: #f1f1f1;
        padding: 10px 0;
        text-align: center;
    }
  </style>
</head>

<body data-home-page="Каталог.html" data-home-page-title="Каталог" data-path-to-root="./" data-include-products="true" class="u-body u-xl-mode" data-lang="ru">

<header class="u-header" id="sec-233d" data-animation-name="" data-animation-duration="0" data-animation-delay="0" data-animation-direction="">
  <h1>Каталог</h1>
  <nav class="u-dropdown-icon u-menu u-menu-dropdown u-menu-1" data-responsive-from="XS" data-submenu-level="on-click">
    <ul class="navbar-nav">
      <li class="nav-item"><a class="nav-link" href="Каталог.html">Каталог</a></li>
      <li class="nav-item"><a class="nav-link" href="Добавление-карточки-книги.html">Добавление книги</a></li>
    </ul>
    <style class="menu-style">
      @media (max-width: 539px) {
        [data-responsive-from="XS"] .u-nav-container {
            display: none;
        }
        [data-responsive-from="XS"] .menu-collapse {
            display: block;
        }
      }
    </style>
  </nav>

  <div class="u-clearfix u-sheet u-valign-top u-sheet-1">
    <!-- Подключение Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <div class="d-flex align-items-center">
      <!-- Кнопка Поиск -->
      <button id="searchButton" class="btn btn-primary me-2">Поиск</button>
      <!-- Кнопка Сбросить поиск -->
      <button id="resetButton" class="btn btn-secondary">Сбросить поиск</button>
    </div>

    <!-- Форма поиска (скрытая по умолчанию) -->
    <form id="searchForm" class="u-border-1 u-border-grey-30 u-search u-search-left u-white u-search-1 mt-3 d-none">
      <div class="input-group">
        <input class="u-search-input form-control" type="search" name="search" value="" placeholder="Введите название книги">
        <button class="btn btn-outline-secondary" type="submit">Искать</button>
      </div>
    </form>
  </div>
</header>

<section class="u-clearfix u-section-1" id="sec-25c7">
  <div class="container mt-4">
    <div class="table-responsive">
      <table class="table table-striped table-bordered">
        <colgroup>
          <col style="width: 16.66%;">
          <col style="width: 16.66%;">
          <col style="width: 16.66%;">
          <col style="width: 16.66%;">
          <col style="width: 16.66%;">
          <col style="width: 16.66%;">
        </colgroup>
        <thead class="table-dark">
        <tr>
          <th>Название книги <button class="sort-button btn btn-sm btn-light" data-column="name">▲</button></th>
          <th>Автор <button class="sort-button btn btn-sm btn-light" data-column="author">▲</button></th>
          <th>Дата издания <button class="sort-button btn btn-sm btn-light" data-column="publication_year">▲</button></th>
          <th>Издательство <button class="sort-button btn btn-sm btn-light" data-column="publishing_company">▲</button></th>
          <th>Количество экземпляров <button class="sort-button btn btn-sm btn-light" data-column="count_of_books">▲</button></th>
          <th>ISBN <button class="sort-button btn btn-sm btn-light" data-column="isbn">▲</button></th>
        </tr>
        </thead>
        <tbody class="u-table-body u-table-body-1">
        <!-- Динамическое содержимое -->
        </tbody>
      </table>
    </div>
  </div>
</section>

<footer class="u-align-center u-clearfix u-container-align-center u-footer u-grey-80 u-footer" id="sec-2f71">
  <div class="u-clearfix u-sheet u-sheet-1">
    <p class="u-small-text u-text u-text-variant u-text-1">О вопросах и проблемах сообщать главному администратору или писать на почту GlobalMaster@book.com</p>
  </div>
</footer>

<section class="u-backlink u-clearfix u-grey-80">
  <p class="u-text">
    <span>Этот сайт был создан с помощью </span>
    <a class="u-link" href="https://nicepage.com/" target="_blank" rel="nofollow">
      <span>Nicepage</span>
    </a>
  </p>
</section>

<!-- Bootstrap JS (если не подключён ранее) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<!-- Пользовательский JavaScript для получения и отображения книг -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    let currentSortColumn = 'name';
    let currentSortOrder = 'asc';
    let currentSearch = '';

    /**
     * Получает текущее значение поля поиска.
     *
     * @return {string} Обрезанная строка поиска.
     */
    function getSearchValue() {
      const searchInput = document.querySelector('.u-search-input');
      return searchInput.value.trim();
    }

    /**
     * Обрабатывает отправку формы поиска.
     *
     * @param {Event} event - Событие отправки формы.
     */
    function handleSearch(event) {
      event.preventDefault(); // Предотвращаем стандартную отправку формы
      currentSearch = getSearchValue();
      // Сбрасываем сортировку к значениям по умолчанию при поиске
      currentSortColumn = 'name';
      currentSortOrder = 'asc';
      resetSortButtons();
      fetchBooks({ search: currentSearch, sort_column: currentSortColumn, sort_order: currentSortOrder });
    }

    /**
     * Обрабатывает нажатие на кнопку "Поиск".
     */
    function handleSearchButton() {
      const searchForm = document.querySelector('#searchForm');
      searchForm.classList.toggle('d-none'); // Переключаем видимость формы поиска
      if (!searchForm.classList.contains('d-none')) {
        document.querySelector('.u-search-input').focus();
      }
    }

    /**
     * Обрабатывает нажатие на кнопку "Сбросить поиск".
     */
    function handleResetButton() {
      currentSearch = '';
      const searchInput = document.querySelector('.u-search-input');
      searchInput.value = '';
      // Сбрасываем сортировку к значениям по умолчанию
      currentSortColumn = 'name';
      currentSortOrder = 'asc';
      resetSortButtons();
      fetchBooks({ search: currentSearch, sort_column: currentSortColumn, sort_order: currentSortOrder });
    }

    /**
     * Сбрасывает все кнопки сортировки к их исходному состоянию.
     */
    function resetSortButtons() {
      const sortButtons = document.querySelectorAll('.sort-button');
      sortButtons.forEach(button => {
        button.setAttribute('data-order', 'asc');
        button.textContent = '▲';
        button.classList.remove('btn-secondary');
        button.classList.add('btn-light');
      });
    }

    /**
     * Получает книги из API на основе предоставленных параметров.
     *
     * @param {Object} params - Параметры запроса для получения книг.
     */
    function fetchBooks(params = {}) {
      const queryParams = new URLSearchParams(params).toString();
      const apiUrl = `/api/books${queryParams ? '?' + queryParams : ''}`;

      fetch(apiUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error('Сетевая ошибка: ' + response.statusText);
          }
          return response.json();
        })
        .then(data => {
          populateTable(data);
        })
        .catch(error => {
          console.error('Ошибка при выполнении запроса:', error);
        });
    }

    /**
     * Заполняет HTML-таблицу полученными данными о книгах.
     *
     * @param {Array} books - Список книг для отображения.
     */
    function populateTable(books) {
      const tableBody = document.querySelector('.u-table-body-1');
      tableBody.innerHTML = '';

      if (books.length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 6;
        cell.className = 'text-center';
        cell.textContent = 'Книги не найдены.';
        row.appendChild(cell);
        tableBody.appendChild(row);
        return;
      }

      books.forEach(book => {
        const row = document.createElement('tr');
        row.style.height = '28px';

        // Название книги (гиперссылка)
        const nameCell = document.createElement('td');
        nameCell.className = 'u-border-1 u-border-grey-30 u-palette-4-light-3 u-table-cell';
        const link = document.createElement('a');
        link.href = `Страница-книги.html?isbn=${book.isbn}`; // Использование ISBN в качестве параметра
        link.textContent = book.name || 'Без названия';
        link.className = 'text-decoration-none';
        link.style.color = '#0d6efd'; // Цвет ссылки по умолчанию Bootstrap
        nameCell.appendChild(link);
        row.appendChild(nameCell);

        // Автор(-ы)
        const authorsCell = document.createElement('td');
        authorsCell.className = 'u-border-1 u-border-grey-30 u-table-cell';
        if (book.authors && Array.isArray(book.authors) && book.authors.length > 0) {
          const authors = book.authors.map(author => author.fio).join(', ');
          authorsCell.textContent = authors;
        } else {
          authorsCell.textContent = 'Неизвестно';
        }
        row.appendChild(authorsCell);

        // Дата издания
        const yearCell = document.createElement('td');
        yearCell.className = 'u-border-1 u-border-grey-30 u-table-cell';
        yearCell.textContent = book.publicationYear || 'Не указано';
        row.appendChild(yearCell);

        // Издательство
        const publishingCell = document.createElement('td');
        publishingCell.className = 'u-border-1 u-border-grey-30 u-table-cell';
        publishingCell.textContent = book.publishingCompany || 'Не указано';
        row.appendChild(publishingCell);

        // Количество экземпляров
        const countCell = document.createElement('td');
        countCell.className = 'u-border-1 u-border-grey-30 u-table-cell';
        countCell.textContent = book.countOfBooks !== undefined ? book.countOfBooks : 'Не указано';
        row.appendChild(countCell);

        // ISBN
        const isbnCell = document.createElement('td');
        isbnCell.className = 'u-border-1 u-border-grey-30 u-table-cell';
        isbnCell.textContent = book.isbn || 'Не указано';
        row.appendChild(isbnCell);

        tableBody.appendChild(row);
      });
    }

    /**
     * Обрабатывает логику сортировки при клике на кнопку сортировки.
     *
     * @param {string} column - Столбец для сортировки.
     * @param {HTMLElement} button - Элемент кнопки сортировки.
     */
    function handleSort(column, button) {
      const currentOrder = button.getAttribute('data-order') || 'asc';
      const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
      button.setAttribute('data-order', newOrder);
      button.textContent = newOrder === 'asc' ? '▲' : '▼';

      // Изменение стилей кнопок сортировки
      const sortButtons = document.querySelectorAll('.sort-button');
      sortButtons.forEach(btn => {
        if (btn !== button) {
          btn.setAttribute('data-order', 'asc');
          btn.textContent = '▲';
          btn.classList.remove('btn-secondary');
          btn.classList.add('btn-light');
        }
      });

      if (newOrder === 'asc') {
        button.classList.remove('btn-secondary');
        button.classList.add('btn-light');
      } else {
        button.classList.remove('btn-light');
        button.classList.add('btn-secondary');
      }

      currentSortColumn = column;
      currentSortOrder = newOrder;
      fetchBooks({ search: currentSearch, sort_column: currentSortColumn, sort_order: currentSortOrder });
    }

    /**
     * Инициализирует обработчики событий для формы поиска и кнопок сортировки.
     */
    function initializeEventListeners() {
      // Добавляем обработчик события к форме поиска
      const searchForm = document.querySelector('#searchForm');
      if (searchForm) {
        searchForm.addEventListener('submit', handleSearch);
      }

      // Добавляем обработчик события к кнопке "Поиск"
      const searchButton = document.querySelector('#searchButton');
      if (searchButton) {
        searchButton.addEventListener('click', handleSearchButton);
      }

      // Добавляем обработчик события к кнопке "Сбросить поиск"
      const resetButton = document.querySelector('#resetButton');
      if (resetButton) {
        resetButton.addEventListener('click', handleResetButton);
      }

      // Инициализируем кнопки сортировки
      const sortButtons = document.querySelectorAll('.sort-button');
      sortButtons.forEach(button => {
        const columnName = button.getAttribute('data-column');
        button.addEventListener('click', () => handleSort(columnName, button));
      });
    }

    // Инициализируем обработчики событий
    initializeEventListeners();

    // Первоначальный запрос для отображения всех книг
    fetchBooks({ search: currentSearch, sort_column: currentSortColumn, sort_order: currentSortOrder });
  });
</script>

</body>
</html>
